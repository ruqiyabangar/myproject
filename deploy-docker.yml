---
- name: Deploy Docker container
  hosts: dev
  become: yes

  tasks:
    - name: Ensure Docker is installed
      yum:
        name: docker
        state: present

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes

    - name: Remove old container if running
      shell: |
        docker rm -f myapp || true
      ignore_errors: yes

    - name: Free up port 8080 if occupied
      shell: |
        if docker ps --format '{{.Ports}}' | grep -q '0.0.0.0:8080'; then
          docker ps --filter "publish=8080" -q | xargs -r docker stop
          docker ps -a --filter "publish=8080" -q | xargs -r docker rm
        fi
      ignore_errors: yes

    - name: Pull latest image from Docker Hub
      shell: docker pull ruqiyataj/img1:latest

    - name: Run new container
      shell: docker run -d --name myapp -p 8080:8080 ruqiyataj/img1:latest
